{% extends "base.html" %}

{% block title %}Upload Reports - Cross-Equipment Comparison{% endblock %}

{% block content %}
<div class="page-header">
    <h1>üìä Cross-Equipment Comparison</h1>
    <p>Upload Excel reports from multiple equipment samples to compare their performance</p>
</div>

<div class="progress-steps">
    <div class="step active">
        <span class="step-number">1</span>
        <span class="step-label">Upload Reports</span>
    </div>
    <div class="step-connector"></div>
    <div class="step">
        <span class="step-number">2</span>
        <span class="step-label">Configure</span>
    </div>
    <div class="step-connector"></div>
    <div class="step">
        <span class="step-number">3</span>
        <span class="step-label">Results</span>
    </div>
</div>

<div class="upload-section">
    <div class="upload-zone-wrapper">
        <div class="upload-zone" id="upload-zone">
            <div class="upload-icon">üìÅ</div>
            <h3>Drag & Drop Excel Reports Here</h3>
            <p>or</p>
        </div>
        <input type="file" id="file-input" multiple accept=".xlsx" hidden>
        <button class="btn btn-primary" id="select-files-btn" onclick="document.getElementById('file-input').click()">
            Select Excel Files
        </button>
    </div>
    
    <div class="upload-info">
        <h4>Required Files</h4>
        <ul>
            <li><strong>Excel reports (.xlsx)</strong> generated by the Equipment-Specific Report feature</li>
            <li>Files should be from the <strong>same equipment type</strong> (e.g., all 50910-xxx)</li>
            <li>Files should have the <strong>same test values</strong> and configurations</li>
        </ul>
        <h4>Example</h4>
        <p>To compare 5 samples of equipment type 50910:</p>
        <code>50910-001.xlsx, 50910-002.xlsx, ..., 50910-005.xlsx</code>
    </div>
</div>

<div class="file-list-section" id="file-list-section" style="display: none;">
    <h3>Uploaded Reports</h3>
    
    <div class="warnings-container" id="warnings-container" style="display: none;">
    </div>
    
    <div class="errors-container" id="errors-container" style="display: none;">
    </div>
    
    <div class="file-stats" id="file-stats"></div>
    <div class="file-list" id="file-list"></div>
    <div class="action-buttons">
        <button class="btn btn-secondary" onclick="clearFiles()">Clear All</button>
        <button class="btn btn-primary" onclick="proceedToConfigure()" id="proceed-btn" disabled>
            Continue to Configuration ‚Üí
        </button>
    </div>
</div>

<div class="loading-overlay" id="loading-overlay" style="display: none;">
    <div class="spinner"></div>
    <p>Validating reports...</p>
</div>
{% endblock %}

{% block scripts %}
<script>
// Upload page functionality for comparison
document.addEventListener('DOMContentLoaded', function() {
    const uploadZone = document.getElementById('upload-zone');
    const fileInput = document.getElementById('file-input');
    const fileListSection = document.getElementById('file-list-section');
    const fileStats = document.getElementById('file-stats');
    const fileList = document.getElementById('file-list');
    const proceedBtn = document.getElementById('proceed-btn');
    const loadingOverlay = document.getElementById('loading-overlay');
    const warningsContainer = document.getElementById('warnings-container');
    const errorsContainer = document.getElementById('errors-container');
    
    // Drag and drop handlers
    uploadZone.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadZone.classList.add('dragover');
    });
    
    uploadZone.addEventListener('dragleave', function(e) {
        e.preventDefault();
        uploadZone.classList.remove('dragover');
    });
    
    uploadZone.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadZone.classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleFiles(files);
        }
    });
    
    // Click on upload zone to browse
    uploadZone.addEventListener('click', function() {
        fileInput.click();
    });
    
    // Handle file selection
    fileInput.addEventListener('change', function() {
        if (fileInput.files.length > 0) {
            handleFiles(fileInput.files);
        }
    });
    
    // Handle file upload
    function handleFiles(files) {
        loadingOverlay.style.display = 'flex';
        
        const formData = new FormData();
        for (let i = 0; i < files.length; i++) {
            formData.append('files', files[i]);
        }
        
        fetch('/api/upload-comparison', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            loadingOverlay.style.display = 'none';
            
            if (data.error) {
                alert('Error: ' + data.error);
                if (data.validation_errors && data.validation_errors.length > 0) {
                    showErrors(data.validation_errors);
                }
                return;
            }
            
            displayFiles(data);
        })
        .catch(error => {
            loadingOverlay.style.display = 'none';
            alert('Upload failed: ' + error.message);
        });
    }
    
    function showWarnings(warnings) {
        if (warnings.length === 0) {
            warningsContainer.style.display = 'none';
            return;
        }
        
        let html = '<div class="warning-box"><h4>‚ö†Ô∏è Warnings</h4><ul>';
        warnings.forEach(w => {
            html += `<li>${w.message}</li>`;
        });
        html += '</ul></div>';
        
        warningsContainer.innerHTML = html;
        warningsContainer.style.display = 'block';
    }
    
    function showErrors(errors) {
        if (errors.length === 0) {
            errorsContainer.style.display = 'none';
            return;
        }
        
        let html = '<div class="error-box"><h4>‚ùå Validation Errors</h4><ul>';
        errors.forEach(e => {
            html += `<li><strong>${e.filename}:</strong> ${e.error}</li>`;
        });
        html += '</ul></div>';
        
        errorsContainer.innerHTML = html;
        errorsContainer.style.display = 'block';
    }
    
    function displayFiles(data) {
        fileListSection.style.display = 'block';
        
        // Show warnings
        showWarnings(data.warnings || []);
        showErrors(data.validation_errors || []);
        
        // Stats
        fileStats.innerHTML = `
            <div class="stat">
                <span class="stat-label">Valid Reports:</span>
                <span class="stat-value">${data.files_count}</span>
            </div>
            <div class="stat">
                <span class="stat-label">Equipment Types:</span>
                <span class="stat-value">${data.equipment_types.join(', ')}</span>
            </div>
        `;
        
        // File list
        let html = '';
        data.files.forEach(file => {
            html += `
                <div class="file-item xlsx">
                    <span class="file-name">${file.filename}</span>
                    <span class="file-info">
                        <span class="badge">${file.sample_id}</span>
                        <span class="badge secondary">${file.channels.length} channels</span>
                        <span class="badge secondary">${file.test_values.length} test values</span>
                    </span>
                </div>
            `;
        });
        fileList.innerHTML = html;
        
        // Enable proceed button only if we have valid files and no critical warnings
        const hasCriticalWarning = (data.warnings || []).some(w => 
            w.type === 'multiple_equipment_types' || w.type === 'mismatched_test_values'
        );
        
        proceedBtn.disabled = data.files_count < 2;
        
        if (data.files_count < 2) {
            fileStats.innerHTML += `
                <div class="stat warning">
                    <span class="stat-label">‚ö†Ô∏è Need at least 2 reports to compare</span>
                </div>
            `;
        }
    }
});

function clearFiles() {
    fetch('/api/reset')
        .then(response => response.json())
        .then(data => {
            document.getElementById('file-list-section').style.display = 'none';
            document.getElementById('file-input').value = '';
            document.getElementById('proceed-btn').disabled = true;
            document.getElementById('warnings-container').style.display = 'none';
            document.getElementById('errors-container').style.display = 'none';
        });
}

function proceedToConfigure() {
    window.location.href = '/comparison-configure';
}
</script>

<style>
.warning-box {
    background: #fff3cd;
    border-left: 4px solid #ffc107;
    padding: 15px;
    margin-bottom: 15px;
    border-radius: 0 8px 8px 0;
}
.warning-box h4 {
    color: #856404;
    margin-bottom: 10px;
}
.warning-box ul {
    margin: 0;
    padding-left: 20px;
    color: #856404;
}
.error-box {
    background: #f8d7da;
    border-left: 4px solid #dc3545;
    padding: 15px;
    margin-bottom: 15px;
    border-radius: 0 8px 8px 0;
}
.error-box h4 {
    color: #721c24;
    margin-bottom: 10px;
}
.error-box ul {
    margin: 0;
    padding-left: 20px;
    color: #721c24;
}
.file-item .file-info {
    display: flex;
    gap: 8px;
}
.badge {
    background: #1F4E78;
    color: white;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 12px;
}
.badge.secondary {
    background: #6c757d;
}
.stat.warning {
    color: #856404;
    background: #fff3cd;
    padding: 8px 12px;
    border-radius: 4px;
}
</style>
{% endblock %}
